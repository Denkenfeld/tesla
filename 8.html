<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>MOON FACTORY â€¢ Lunar Surface Update</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    body { margin:0; padding:0; overflow:hidden; background:#1a1c23; font-family:sans-serif; touch-action:none; color:#eee; }
    canvas { display:block; }
    #ui { position:absolute; inset:0; pointer-events:none; z-index:10; display:flex; flex-direction:column; }
    #top { background:rgba(20,22,30,0.9); border-bottom:2px solid #555; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; font-size:16px; font-weight:bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    .res { display:flex; gap:20px; }
    .res span { color: #0ff; text-shadow: 0 0 5px #0ff; }
    .res span.cred { color: #fd0; text-shadow: 0 0 5px #fd0; }
    
    #toolbar { background:rgba(20,22,30,0.9); padding:10px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center; pointer-events:auto; border-top:2px solid #555; }
    .tool { 
        width:85px; height:85px; background:#2a2d38; border:2px solid #444; border-radius:10px; 
        display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:11px; color:#ddd; 
        cursor:pointer; position:relative; transition:0.1s;
    }
    .tool:hover { border-color: #0ff; background:#3a3d48; }
    .tool.active { border-color: #0f0; background:#224422; transform:scale(0.95); }
    .cost { position:absolute; bottom:4px; font-size:9px; color:#fd0; text-align:center; }
    
    #side { position:absolute; right:16px; top:70px; width:280px; background:rgba(20,22,30,0.95); border:1px solid #777; border-radius:12px; padding:16px; display:none; pointer-events:auto; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
    .btn { padding:10px; border:none; border-radius:6px; font-size:14px; font-weight:bold; cursor:pointer; width:100%; margin-top:8px; }
    .btn-up { background:#0ff; color:#000; }
    .btn-del { background:#f44; color:#fff; }
    
    #cinematic { position:absolute; inset:0; background:#000; z-index:100; display:none; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:40px; }
    #quote { color:#fff; font-size:24px; font-style:italic; opacity:0; transition: opacity 3s; max-width: 600px; line-height:1.5; }
    #rocket-anim { font-size: 80px; position:absolute; bottom:-100px; transition: bottom 5s ease-in, transform 5s; }
</style>
</head>
<body>
<canvas id="c"></canvas>

<div id="ui">
    <div id="top">
        <div>MOON FACTORY</div>
        <div class="res">
            <div>ðŸª¨ Erz: <span id="r-ore">0</span></div>
            <div>ðŸ”‹ Lith: <span id="r-lith">0</span></div>
            <div>ðŸ”© Met: <span id="r-metal">0</span></div>
            <div>âš¡ Zell: <span id="r-cells">0</span></div>
            <div>ðŸ’° <span id="r-cred" class="cred">150</span></div>
        </div>
    </div>
    <div style="flex-grow:1;"></div>
    <div id="toolbar"></div>
</div>

<div id="side">
    <div id="selName" style="font-size:18px; font-weight:bold; margin-bottom:10px; color:#0ff;"></div>
    <div id="selInfo" style="margin-bottom:10px; font-size:13px; line-height:1.5; color:#ccc;"></div>
    <button onclick="upgradeSel()" class="btn btn-up">Upgrade (<span id="upCost"></span> ðŸ’°)</button>
    <button onclick="destroySel()" class="btn btn-del">AbreiÃŸen</button>
</div>

<div id="cinematic">
    <div id="rocket-anim">ðŸš€</div>
    <div id="quote">"Zeit und Raum sind nicht Bedingungen, in denen wir leben, sondern Modi, in denen wir denken."<br><br><span style="font-size:16px; color:#aaa;">- Albert Einstein</span><br><br><br><span style="color:#0ff; font-weight:bold; font-style:normal;">MISSION ERFOLGREICH</span></div>
</div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W, H, camX = 0, camY = 0, zoom = 1.0;

let res = { ore: 0, lith: 0, metal: 0, cells: 0, cred: 200 };
let buildings = [];
let popups = [];
let gameState = 'playing';

const TILE = 80;
const MAP_SIZE = 60; // 60x60 map (3600 tiles)
const mapData = {}; // Speichert Terrain. 1=Krater, 2=Erz, 3=Lithium

// Terrain Generation
Math.seedrandom = (s) => {
    let x = Math.sin(s++) * 10000;
    return x - Math.floor(x);
};
for(let x=-MAP_SIZE/2; x<MAP_SIZE/2; x++) {
    for(let y=-MAP_SIZE/2; y<MAP_SIZE/2; y++) {
        let rand = Math.seedrandom(x*13.1 + y*97.3);
        if(rand < 0.05) mapData[`${x},${y}`] = 1; // 5% Krater
        else if(rand < 0.12) mapData[`${x},${y}`] = 2; // 7% Eisenerz
        else if(rand < 0.16) mapData[`${x},${y}`] = 3; // 4% Lithium
    }
}

const BUILDINGS = {
    miner:   { name:"Miner",      emoji:"â›ï¸", col:"#777", cost: 50,  w:1, h:1, rate: 2,  req: "patch" },
    smelter: { name:"Schmelze",   emoji:"ðŸ”¥", col:"#d50", cost: 150, w:1, h:1, rate: 1,  in: "ore", out: "metal" },
    refinery:{ name:"Raffinerie", emoji:"âš¡", col:"#0aa", cost: 300, w:1, h:1, rate: 0.5,in: "lith", out: "cells" },
    hub:     { name:"Collector",  emoji:"ðŸ“¡", col:"#26a", cost: 500, w:2, h:2, rate: 1,  sells: true },
    ship:    { name:"Raumschiff", emoji:"ðŸš€", col:"#ddd", cost: 5000,w:3, h:3, rate: 0,  endgame: true }
};

class Building {
    constructor(x,y,type) {
        this.x = x; this.y = y; this.type = type; this.t = BUILDINGS[type];
        this.level = 1; this.prog = 0; 
        
        // Finde heraus, was der Miner abbaut
        if(type === 'miner') {
            let tile = mapData[`${x},${y}`];
            this.mines = (tile === 2) ? 'ore' : (tile === 3 ? 'lith' : null);
        }
    }
}

let activeTool = null, selected = null;
let touches = {};

function addPopup(x, y, text, color) {
    popups.push({ x: x, y: y, text: text, col: color, life: 60, maxLife: 60 });
}

canvas.addEventListener('pointerdown', e => {
    if(gameState !== 'playing' || e.target.tagName !== 'CANVAS') return;
    touches[e.pointerId] = {x:e.clientX, y:e.clientY, moved:false};
});

canvas.addEventListener('pointermove', e => {
    if (touches[e.pointerId]) {
        camX += (e.clientX - touches[e.pointerId].x);
        camY += (e.clientY - touches[e.pointerId].y);
        touches[e.pointerId].x = e.clientX;
        touches[e.pointerId].y = e.clientY;
        touches[e.pointerId].moved = true;
    }
});

canvas.addEventListener('pointerup', e => {
    let t = touches[e.pointerId];
    delete touches[e.pointerId];
    if(t && t.moved) return; // War ein Drag zum Bewegen, kein Klick

    const gx = Math.floor((e.clientX - camX - W/2) / (TILE*zoom));
    const gy = Math.floor((e.clientY - camY - H/2) / (TILE*zoom));

    if (activeTool) {
        const bd = BUILDINGS[activeTool];
        const tile = mapData[`${gx},${gy}`];
        
        // Bau-Validierung
        if(buildings.some(b => gx >= b.x && gx < b.x+b.t.w && gy >= b.y && gy < b.y+b.t.h)) return addPopup(gx, gy, "Blockiert!", "#f44");
        if(tile === 1) return addPopup(gx, gy, "Krater!", "#f44");
        if(bd.req === 'patch' && tile !== 2 && tile !== 3) return addPopup(gx, gy, "Braucht Erz/Lithium!", "#f44");
        
        if (res.cred >= bd.cost) {
            res.cred -= bd.cost;
            buildings.push(new Building(gx, gy, activeTool));
            addPopup(gx, gy, "-"+bd.cost+"ðŸ’°", "#f44");
            if(bd.endgame) triggerEndgame();
        } else {
            addPopup(gx, gy, "Zu teuer!", "#f44");
        }
    } else {
        selected = buildings.find(b => gx >= b.x && gx < b.x + b.t.w && gy >= b.y && gy < b.y + b.t.h);
        const sUI = document.getElementById('side');
        if (selected) {
            sUI.style.display = 'block';
            updateSide();
        } else { sUI.style.display = 'none'; }
    }
});

canvas.addEventListener('wheel', e => {
    let oldZ = zoom;
    zoom *= e.deltaY < 0 ? 1.1 : 0.9;
    zoom = Math.max(0.3, Math.min(2.0, zoom));
    camX = e.clientX - (e.clientX - camX) * (zoom / oldZ);
    camY = e.clientY - (e.clientY - camY) * (zoom / oldZ);
});

function updateSide() {
    if(!selected) return;
    document.getElementById('selName').innerText = `${selected.t.emoji} ${selected.t.name} (Lv.${selected.level})`;
    let info = "";
    if(selected.type === 'miner') info = `Baut ab: ${selected.mines==='ore'?'Erz':'Lithium'}<br>Tempo: ${selected.t.rate * selected.level}/s`;
    else if(selected.t.in) info = `Wandelt ${selected.t.in} in ${selected.t.out} um.`;
    else if(selected.t.sells) info = "Verkauft Metalle & Zellen fÃ¼r Credits.";
    else if(selected.t.endgame) info = "Dein Ticket nach Hause.";
    
    document.getElementById('selInfo').innerHTML = info;
    document.getElementById('upCost').innerText = selected.t.cost * selected.level * 2;
}

function upgradeSel() {
    if(!selected || selected.t.endgame) return;
    let cost = selected.t.cost * selected.level * 2;
    if(res.cred >= cost) {
        res.cred -= cost;
        selected.level++;
        updateSide();
        addPopup(selected.x, selected.y, "UPGRADE!", "#0f0");
    }
}

function destroySel() {
    if(!selected) return;
    res.cred += Math.floor(selected.t.cost * 0.5);
    buildings = buildings.filter(b => b !== selected);
    selected = null; document.getElementById('side').style.display = 'none';
}

function makeToolbar() {
    const tb = document.getElementById('toolbar');
    tb.innerHTML = '';
    Object.keys(BUILDINGS).forEach(k => {
        const b = BUILDINGS[k];
        const el = document.createElement('div');
        el.className = 'tool';
        el.innerHTML = `<span style="font-size:24px">${b.emoji}</span><b>${b.name}</b><div class="cost">${b.cost} ðŸ’°</div>`;
        el.onclick = () => { 
            document.querySelectorAll('.tool').forEach(t=>t.classList.remove('active'));
            if(activeTool === k) { activeTool = null; } 
            else { activeTool = k; el.classList.add('active'); }
        };
        tb.appendChild(el);
    });
}

function isNeighbor(a, b) {
    return (Math.max(a.x, b.x) - Math.min(a.x + (a.t.w||1), b.x) <= 0) &&
           (Math.max(a.y, b.y) - Math.min(a.y + (a.t.h||1), b.y) <= 0);
}

function triggerEndgame() {
    gameState = 'ended';
    const cine = document.getElementById('cinematic');
    const rock = document.getElementById('rocket-anim');
    const quote = document.getElementById('quote');
    cine.style.display = 'flex';
    
    setTimeout(() => {
        rock.style.bottom = "120%";
        rock.style.transform = "scale(0.5)";
    }, 500);
    
    setTimeout(() => { quote.style.opacity = 1; }, 3000);
}

function draw() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    
    // Background Moon Dust
    ctx.fillStyle = '#1a1c23'; ctx.fillRect(0,0,W,H);
    
    const offX = camX + W/2;
    const offY = camY + H/2;
    const sT = TILE * zoom;

    // Viewport Culling Bounds
    const minX = Math.floor(-offX / sT) - 1;
    const maxX = Math.floor((W - offX) / sT) + 1;
    const minY = Math.floor(-offY / sT) - 1;
    const maxY = Math.floor((H - offY) / sT) + 1;

    // Draw Grid & Terrain
    ctx.lineWidth = 1;
    for(let x = Math.max(-MAP_SIZE/2, minX); x < Math.min(MAP_SIZE/2, maxX); x++) {
        for(let y = Math.max(-MAP_SIZE/2, minY); y < Math.min(MAP_SIZE/2, maxY); y++) {
            const px = offX + x * sT;
            const py = offY + y * sT;
            const tile = mapData[`${x},${y}`];
            
            ctx.strokeStyle = '#2a2d38';
            ctx.strokeRect(px, py, sT, sT);
            
            if(tile === 1) { // Krater
                ctx.fillStyle = '#111';
                ctx.beginPath(); ctx.arc(px+sT/2, py+sT/2, sT*0.4, 0, Math.PI*2); ctx.fill();
            } else if(tile === 2) { // Erz
                ctx.fillStyle = '#655'; ctx.fillRect(px+4, py+4, sT-8, sT-8);
            } else if(tile === 3) { // Lithium
                ctx.fillStyle = '#168'; ctx.fillRect(px+4, py+4, sT-8, sT-8);
            }
        }
    }

    // Draw Buildings
    buildings.forEach(b => {
        const px = offX + b.x * sT;
        const py = offY + b.y * sT;
        const bw = b.t.w * sT;
        const bh = b.t.h * sT;

        // Base
        ctx.fillStyle = b.t.col;
        ctx.fillRect(px+2, py+2, bw-4, bh-4);
        
        if(selected === b) {
            ctx.strokeStyle = '#0ff'; ctx.lineWidth = 3;
            ctx.strokeRect(px, py, bw, bh);
        }

        // Emoji
        ctx.font = `${30*zoom}px sans-serif`;
        ctx.textAlign = "center"; ctx.textBaseline = "middle";
        ctx.fillText(b.t.emoji, px + bw/2, py + bh/2 - (b.t.rate?5*zoom:0));
        
        // Progress Bar
        if(b.t.rate > 0 && !b.t.sells) {
            ctx.fillStyle = '#000';
            ctx.fillRect(px + 4, py + bh - 10*zoom, bw - 8, 6*zoom);
            ctx.fillStyle = '#0f0';
            ctx.fillRect(px + 4, py + bh - 10*zoom, (bw - 8) * (b.prog/100), 6*zoom);
        }
    });

    // Draw Popups
    popups.forEach(p => {
        const px = offX + (p.x + 0.5) * sT;
        const py = offY + (p.y) * sT - (1 - p.life/p.maxLife)*30*zoom;
        ctx.fillStyle = p.col;
        ctx.globalAlpha = p.life / p.maxLife;
        ctx.font = `bold ${16*zoom}px sans-serif`;
        ctx.textAlign = "center";
        ctx.fillText(p.text, px, py);
    });
    ctx.globalAlpha = 1;
}

function gameTick() {
    if(gameState !== 'playing') return;
    
    buildings.forEach(b => {
        if(!b.t.rate) return;

        let canWork = false;
        if(b.type === 'miner' && b.mines) canWork = true;
        if(b.type === 'smelter' && res.ore > 0) canWork = true;
        if(b.type === 'refinery' && res.lith > 0) canWork = true;
        if(b.type === 'hub') canWork = true; // Immer bereit zu verkaufen

        if(canWork) {
            b.prog += b.t.rate * b.level * 2;
            if(b.prog >= 100) {
                b.prog = 0;
                
                if(b.type === 'miner') {
                    res[b.mines] += b.level;
                    addPopup(b.x, b.y, "+"+b.level, b.mines==='ore'?"#aaa":"#0ff");
                }
                else if(b.type === 'smelter') {
                    res.ore--; res.metal += b.level;
                    addPopup(b.x, b.y, "+"+b.level+" Met", "#d50");
                }
                else if(b.type === 'refinery') {
                    res.lith--; res.cells += b.level;
                    addPopup(b.x, b.y, "+"+b.level+" Zell", "#0aa");
                }
                else if(b.type === 'hub') {
                    let earned = 0;
                    // Hub sucht in der Umgebung nach Dingen zum Verkaufen
                    const neighbors = buildings.filter(o => isNeighbor(b, o));
                    neighbors.forEach(n => {
                        if(n.type === 'smelter' && res.metal > 0) { res.metal--; earned += 15; }
                        if(n.type === 'refinery' && res.cells > 0) { res.cells--; earned += 35; }
                    });
                    if(earned > 0) {
                        res.cred += earned;
                        addPopup(b.x, b.y, "+"+earned+"ðŸ’°", "#fd0");
                    }
                }
            }
        } else {
            b.prog = 0; // Reset wenn Input fehlt
        }
    });

    // Popups updaten
    for(let i=popups.length-1; i>=0; i--) {
        popups[i].life--;
        if(popups[i].life <= 0) popups.splice(i,1);
    }

    // UI updaten
    document.getElementById('r-ore').innerText = res.ore;
    document.getElementById('r-lith').innerText = res.lith;
    document.getElementById('r-metal').innerText = res.metal;
    document.getElementById('r-cells').innerText = res.cells;
    document.getElementById('r-cred').innerText = res.cred;
}

makeToolbar();
setInterval(gameTick, 50); // Schnellere Simulation (20 Ticks/s)
function loop() { draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
