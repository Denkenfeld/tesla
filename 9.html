<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Tesla Miner - Weltraum Edition</title>
  <style>
    :root { --t-red: #e31937; --bg: #05080c; --ui-dark: #111; --ui-light: #2a2a2a; }
    body { margin: 0; background: #000; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; user-select: none; }
    canvas { display: block; width: 100vw; height: 100vh; }
    
    /* HUD & UI */
    #hud { position: fixed; top: 15px; left: 15px; pointer-events: none; z-index: 100; text-shadow: 2px 2px 4px black; }
    #money-display { font-size: 36px; font-weight: 900; color: #4dff88; margin-bottom: -5px; letter-spacing: 1px; }
    #depth-info { font-size: 16px; color: #aaa; font-weight: bold; text-transform: uppercase; }

    /* Alarm */
    #alarm { position: fixed; inset: 0; pointer-events: none; z-index: 99; mix-blend-mode: overlay;}
    .low-fuel { background: radial-gradient(circle at center, transparent 40%, rgba(227, 25, 55, 0.6) 100%); animation: pulse 1s ease-in-out infinite alternate; }
    @keyframes pulse { from { opacity: 0.3; } to { opacity: 1; } }

    /* Controls */
    #ctrls { position: fixed; bottom: 30px; right: 30px; display: grid; grid-template-areas: ". u ." "l . r" ". d ."; gap: 15px; z-index: 100; }
    .btn { width: 80px; height: 80px; background: linear-gradient(145deg, #333, #222); border: 2px solid #555; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 35px; color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.5), inset 0 2px 5px rgba(255,255,255,0.1); }
    .btn:active { background: #111; transform: scale(0.95); box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

    /* Workshop & Buttons */
    #dock-btn { position: fixed; bottom: 30px; left: 30px; padding: 20px 30px; background: linear-gradient(to right, var(--t-red), #ff4d4d); border: none; color: white; border-radius: 15px; font-weight: 900; font-size: 18px; display: none; z-index: 101; box-shadow: 0 0 25px rgba(227, 25, 55, 0.6); cursor: pointer; text-transform: uppercase; animation: float 2s ease-in-out infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    
    #workshop { position: fixed; inset: 0; background: rgba(5, 8, 12, 0.95); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
    .ws-panel { width: 90%; max-width: 500px; background: linear-gradient(160deg, #222, #111); border: 3px solid var(--t-red); border-radius: 25px; padding: 25px; box-shadow: 0 0 40px rgba(227, 25, 55, 0.3); position: relative; overflow: hidden; }
    .ws-panel::before { content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(227,25,55,0.05) 10px, rgba(227,25,55,0.05) 20px); pointer-events: none; }
    .ws-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; position: relative; z-index: 2; }
    .ws-header h2 { margin: 0; color: var(--t-red); text-transform: uppercase; letter-spacing: 2px; font-weight: 900; }
    .close-btn { background: #333; border: 1px solid #555; color: white; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
    .upg-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 15px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #333; position: relative; z-index: 2; transition: border-color 0.3s; }
    .upg-row:hover { border-color: var(--t-red); }
    .upg-btn { background: linear-gradient(to right, #4dff88, #2db866); color: #000; border: none; padding: 12px 25px; border-radius: 8px; font-weight: 900; font-size: 16px; cursor: pointer; box-shadow: 0 4px 10px rgba(77, 255, 136, 0.3); transition: transform 0.1s; }
    .upg-btn:active { transform: scale(0.95); }
    .upg-btn:disabled { background: #444; color: #888; box-shadow: none; cursor: not-allowed; }
  </style>
</head>
<body>

<div id="alarm"></div>

<div id="hud">
  <div id="money-display">$0</div>
  <div id="depth-info">Tiefe: 0m</div>
</div>

<div id="ctrls">
  <div class="btn" id="u" style="grid-area:u">▲</div>
  <div class="btn" id="l" style="grid-area:l">◀</div>
  <div class="btn" id="r" style="grid-area:r">▶</div>
  <div class="btn" id="d" style="grid-area:d">▼</div>
</div>

<button id="dock-btn">WERKSTATT</button>

<div id="workshop">
  <div class="ws-panel">
    <div class="ws-header">
      <h2>Tesla Systems</h2>
      <button class="close-btn" onclick="document.getElementById('workshop').style.display='none'">X</button>
    </div>
    <div class="upg-row">
      <div><strong style="color:#fff; font-size:18px;">Wartung</strong><br><small style="color:#aaa">Repariert Hülle & schärft Bohrer</small></div>
      <button class="upg-btn" id="btn-rep" onclick="buy('rep')">$10</button>
    </div>
    <div class="upg-row">
      <div><strong style="color:#fff; font-size:18px;">Tank Erweitern</strong><br><small style="color:#aaa">+20% Kapazität</small></div>
      <button class="upg-btn" id="btn-fuel" onclick="buy('fuel')">$50</button>
    </div>
    <div class="upg-row">
      <div><strong style="color:#fff; font-size:18px;">Frachtraum Plus</strong><br><small style="color:#aaa">Mehr Platz für Erze</small></div>
      <button class="upg-btn" id="btn-cargo" onclick="buy('cargo')">$50</button>
    </div>
    <div class="upg-row">
      <div><strong style="color:#fff; font-size:18px;">Diamant-Bohrkopf</strong><br><small style="color:#aaa">Bohrt härtestes Gestein</small></div>
      <button class="upg-btn" id="btn-drill" onclick="buy('drill')">$250</button>
    </div>
  </div>
</div>

<canvas id="c"></canvas>

<script>
// Spiel-Engine II
(() => {
  const cv = document.getElementById("c"), ctx = cv.getContext("2d");
  let vw, vh;
  function res() { vw=innerWidth; vh=innerHeight; cv.width=vw; cv.height=vh; }
  window.onresize = res; res();

  const TILE = 60, W = 80, H = 800, SURFACE = 20; // Surface höher gesetzt für mehr Platz für den Palast
  const world = new Uint8Array(W*H), damage = new Float32Array(W*H);
  const keys = new Set();
  const popups = [];
  let dockPulse = 0;

  // Sterne initialisieren
  const stars = [];
  for(let i=0; i<200; i++) {
    stars.push({
      x: Math.random() * W * TILE,
      y: Math.random() * SURFACE * TILE - (SURFACE*TILE*2), // Gehen weit nach oben
      r: Math.random() * 2 + 1,
      a: Math.random()
    });
  }

  const T = { Air:0, Dirt:1, Rock:2, Coal:3, Gold:4, Gem:5, Lava:6, Water:7, Gas:8, Pad:9 };
  const T_D = {
    [T.Dirt]:  { c: "#4b3621", hp: 20,  val: 1,   lvl: 0 },
    [T.Rock]:  { c: "#3a3a3a", hp: 80,  val: 5,   lvl: 0 },
    [T.Coal]:  { c: "#111111", hp: 100, val: 30,  lvl: 0 },
    [T.Gold]:  { c: "#ffd700", hp: 250, val: 150, lvl: 1 },
    [T.Gem]:   { c: "#00f2ff", hp: 500, val: 600, lvl: 2 },
    [T.Lava]:  { c: "#ff4500", hp: 10,  val: 0,   lvl: 0, dmg: 50 },
    [T.Water]: { c: "#1e90ff", hp: 10,  val: 0,   lvl: 0, dmg: 10 },
    [T.Gas]:   { c: "#8fbc8f", hp: 10,  val: 0,   lvl: 0, dmg: 20 },
    [T.Pad]:   { c: "#555",    hp: 9999 }
  };

  window.p = { 
    x: (W/2)*TILE, y: (SURFACE-2)*TILE, vx:0, vy:0, angle: Math.PI/2,
    f:40, fM:40, hp:100, hpM:100, c:0, cM:30, cV:0,
    sharp: 100, drillLvl: 0, money: 15, totalEarned: 0,
    shake: 0
  };

  const worm = { active: false, x: 0, y: 0, vx: 0, r: 25 };

  // Weltengenerierung
  for(let i=0; i<W*H; i++) {
    let y = Math.floor(i/W);
    if(y >= SURFACE) {
      let r = Math.random(), d = y - SURFACE, t = T.Dirt;
      if(r < 0.2) t = T.Rock;
      if(r < 0.08) t = T.Coal;
      if(d > 20 && r < 0.04) t = T.Gold;
      if(d > 50 && r < 0.02) t = T.Gem;
      if(d > 10 && r > 0.95) t = T.Water;
      if(d > 30 && r > 0.97) t = T.Gas;
      if(d > 60 && r > 0.98) t = T.Lava;
      world[i] = t; damage[i] = T_D[t]?.hp || 0;
    }
  }
  for(let x=Math.floor(W/2-3); x<=Math.floor(W/2+3); x++) world[x+SURFACE*W] = T.Pad;

  const bind = (id, k) => {
    const el = document.getElementById(id);
    el.onpointerdown = (e) => { e.preventDefault(); keys.add(k); };
    el.onpointerup = el.onpointerleave = () => keys.delete(k);
  };
  bind("u","w"); bind("d","s"); bind("l","a"); bind("r","d");

  window.buy = (type) => {
    if(type === 'rep' && p.money >= 10) { p.money -= 10; p.hp = p.hpM; p.sharp = 100; }
    if(type === 'fuel' && p.money >= 50) { p.money -= 50; p.fM += 20; document.getElementById('btn-fuel').innerText = "$" + (50 + (p.fM-40)*2); }
    if(type === 'cargo' && p.money >= 50) { p.money -= 50; p.cM += 20; document.getElementById('btn-cargo').innerText = "$" + (50 + (p.cM-30)*2); }
    if(type === 'drill' && p.money >= 250 && p.drillLvl < 2) { p.money -= 250; p.drillLvl++; document.getElementById('btn-drill').innerText = p.drillLvl >= 2 ? "MAX" : "$1000"; if(p.drillLvl==1) document.getElementById('btn-drill').onclick = ()=>buy('drill2'); }
    if(type === 'drill2' && p.money >= 1000) { p.money -= 1000; p.drillLvl = 2; document.getElementById('btn-drill').innerText = "MAX"; }
    updateShopUI();
  };

  function updateShopUI() {
    document.getElementById('btn-rep').disabled = (p.money < 10);
    document.getElementById('btn-fuel').disabled = (p.money < parseInt(document.getElementById('btn-fuel').innerText.substring(1)));
    document.getElementById('btn-cargo').disabled = (p.money < parseInt(document.getElementById('btn-cargo').innerText.substring(1)));
    document.getElementById('btn-drill').disabled = (p.money < parseInt(document.getElementById('btn-drill').innerText.substring(1)) || p.drillLvl >= 2);
  }

  document.getElementById("dock-btn").onclick = () => {
    updateShopUI();
    document.getElementById("workshop").style.display = "flex";
  };

  let lastTime = performance.now();
  function update() {
    let now = performance.now();
    let dt = Math.min((now - lastTime) / 1000, 0.05);
    lastTime = now;

    if(p.hp <= 0) {
      p.x = (W/2)*TILE; p.y = (SURFACE-2)*TILE; p.hp = p.hpM; p.f = p.fM; p.money = Math.max(0, p.money - 50); p.c = 0; p.cV = 0;
      return requestAnimationFrame(update);
    }

    let moving = false;
    p.shake = 0;
    if(keys.has("w") && p.f > 0) { p.vy -= 40*dt; moving=true; p.angle = -Math.PI/2; }
    if(keys.has("s") && p.f > 0) { p.vy += 30*dt; moving=true; p.angle = Math.PI/2; }
    if(keys.has("a") && p.f > 0) { p.vx -= 30*dt; moving=true; p.angle = Math.PI; }
    if(keys.has("d") && p.f > 0) { p.vx += 30*dt; moving=true; p.angle = 0; }
    
    if(moving) { p.shake = Math.sin(now/20)*2; p.f -= 3 * dt; } else { p.f -= 0.5 * dt; }
    p.vx *= 0.85; p.vy += 12 * dt;
    if(p.f < 0) p.f = 0;

    document.getElementById("alarm").className = (p.f > 0 && p.f < p.fM * 0.25) ? "low-fuel" : "";

    let nx = p.x + p.vx, ny = p.y + p.vy;
    const canMove = (tx, ty) => {
      let gx = Math.floor(tx/TILE), gy = Math.floor(ty/TILE);
      if(gx < 0 || gx >= W || gy >= H) return false;
      let id = gx + gy*W;
      let t = world[id];
      
      if(t !== T.Air && t !== T.Pad && gy >= SURFACE) {
        if(t === T.Lava || t === T.Water || t === T.Gas) {
          p.hp -= T_D[t].dmg * dt * 5; 
          world[id] = T.Air;
          popups.push({x: tx, y: ty, t: "-HP!", c: "#ff4d4d", life: 1.0, s: 1.5});
          return true;
        }
        if(moving && p.c < p.cM) {
          if(p.drillLvl >= T_D[t].lvl) {
             let dmg = (30 + p.drillLvl*30) * Math.max(0.2, p.sharp/100) * dt;
             damage[id] -= dmg;
             p.sharp -= 1.5 * dt;
             p.shake = Math.sin(now/10)*4; // Stärkeres Wackeln beim Bohren
             if(damage[id] <= 0) {
               p.c += 1; p.cV += T_D[t].val;
               popups.push({x: tx, y: ty, t: `+$${T_D[t].val}`, c: "#4dff88", life: 1.0, s: 1.2});
               world[id] = T.Air;
             }
          } else {
             popups.push({x: tx, y: ty, t: `Upgrade nötig!`, c: "#ffb84d", life: 0.5, s: 1.0});
          }
        }
        return false;
      }
      return true;
    };

    if(canMove(nx, p.y)) p.x = nx; else p.vx = 0;
    if(canMove(p.x, ny)) p.y = ny; else p.vy = 0;

    if(!worm.active && p.y > (SURFACE + 30)*TILE && Math.random() < 0.001) {
      worm.active = true; worm.y = p.y + (Math.random() > 0.5 ? 200 : -200); worm.vx = Math.random() > 0.5 ? 150 : -150; worm.x = worm.vx > 0 ? p.x - vw : p.x + vw;
    }
    if(worm.active) {
      worm.x += worm.vx * dt;
      if(Math.hypot(p.x - worm.x, p.y - worm.y) < worm.r + 20) { p.hp -= 30 * dt; popups.push({x: p.x, y: p.y-30, t: "WURM-BISS!", c: "red", life: 0.5, s:1.5}); }
      if(Math.abs(worm.x - p.x) > vw * 1.5) worm.active = false;
    }

    const onPad = Math.floor(p.y/TILE) <= SURFACE && Math.abs(p.x - (W/2)*TILE) < 4*TILE;
    if(onPad) {
      if(p.c > 0) { 
        p.totalEarned += p.cV; p.money += p.cV; 
        popups.push({x: p.x, y: p.y-40, t: `VERKAUFT: +$${p.cV}`, c: "#ffd700", life: 1.5, s: 2.0});
        p.c = 0; p.cV = 0;
        dockPulse = 1.0; 
      }
      p.f = Math.min(p.fM, p.f + 100*dt);
      document.getElementById("dock-btn").style.display = "block";
    } else {
      document.getElementById("dock-btn").style.display = "none";
      document.getElementById("workshop").style.display = "none";
    }
    dockPulse = Math.max(0, dockPulse - dt*2);

    for(let i=popups.length-1; i>=0; i--) {
      popups[i].y -= 60 * dt; popups[i].life -= dt;
      if(popups[i].life <= 0) popups.splice(i, 1);
    }

    draw();
    requestAnimationFrame(update);
  }

  function draw() {
    // Himmel & Sterne
    let skyGrad = ctx.createLinearGradient(0, 0, 0, vh);
    skyGrad.addColorStop(0, "#020510"); skyGrad.addColorStop(1, "#0a0a14");
    ctx.fillStyle = skyGrad; ctx.fillRect(0,0,vw,vh);

    ctx.save();
    let camX = -p.x + vw/2, camY = -p.y + vh/2;
    ctx.translate(camX, camY);

    // Sterne zeichnen (nur wenn Kamera oben ist)
    if(camY > -SURFACE*TILE*2) {
        ctx.fillStyle = "white";
        stars.forEach(s => {
             ctx.globalAlpha = s.a * (Math.sin(performance.now()/500 + s.x)+1)/2; // Funkeln
             ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill();
        });
        ctx.globalAlpha = 1.0;
    }

    // Palast (Wächst unendlich & verändert Aussehen)
    let hCount = Math.floor(p.totalEarned / 500);
    for(let i=0; i<hCount; i++) {
      let floorY = (SURFACE-1-i)*TILE;
      // Stil ändert sich mit der Höhe
      if(i < 10) { // Basis
         ctx.fillStyle = `hsl(20, 40%, ${40+i*2}%)`; ctx.fillRect((W/2-2)*TILE, floorY, 4*TILE, TILE);
         ctx.fillStyle = "#3a2e25"; ctx.fillRect((W/2-1.5)*TILE, floorY+10, TILE/2, TILE/2); ctx.fillRect((W/2+1.0)*TILE, floorY+10, TILE/2, TILE/2);
      } else if (i < 25) { // Wolkenkratzer
         ctx.fillStyle = `hsl(200, 20%, ${30+(i-10)*2}%)`; ctx.fillRect((W/2-2)*TILE, floorY, 4*TILE, TILE);
         ctx.fillStyle = "#ffd700"; ctx.fillRect((W/2-1.8)*TILE, floorY, 0.2*TILE, TILE); ctx.fillRect((W/2+1.6)*TILE, floorY, 0.2*TILE, TILE); // Goldstreifen
         ctx.fillStyle = "rgba(255,255,200,0.8)"; ctx.fillRect((W/2-1)*TILE, floorY+10, 2*TILE, TILE-20); // Großes Fenster
      } else { // Weltraum-Zitadelle
         ctx.fillStyle = `hsla(${180+(i*5)%180}, 80%, 40%, 0.8)`; ctx.fillRect((W/2-2 + Math.sin(i)*0.2)*TILE, floorY, 4*TILE, TILE-5); // Schwebend
         ctx.shadowBlur = 20; ctx.shadowColor = "#0ff";
         ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc((W/2)*TILE, floorY+TILE/2, 10, 0, Math.PI*2); ctx.fill(); // Energiekern
         ctx.shadowBlur = 0;
      }
    }

    // Welt zeichnen
    let x0 = Math.floor(-camX/TILE), x1 = x0 + Math.ceil(vw/TILE)+1;
    let y0 = Math.floor(-camY/TILE), y1 = y0 + Math.ceil(vh/TILE)+1;
    for(let y=Math.max(0,y0); y<Math.min(H,y1); y++) {
      for(let x=Math.max(0,x0); x<Math.min(W,x1); x++) {
        let id = x+y*W, t = world[id];
        if(t !== T.Air) {
          ctx.fillStyle = T_D[t].c;
          if(t===T.Pad && dockPulse > 0) { // Dock leuchtet beim Verkauf
             ctx.fillStyle = `rgb(${85+dockPulse*100}, ${85+dockPulse*50}, 85)`;
          }
          ctx.fillRect(x*TILE, y*TILE, TILE-1, TILE-1);
          if(t===T.Gold || t===T.Gem) { ctx.fillStyle = "rgba(255,255,255,0.4)"; ctx.beginPath(); ctx.moveTo(x*TILE, y*TILE); ctx.lineTo(x*TILE+25, y*TILE); ctx.lineTo(x*TILE, y*TILE+25); ctx.fill(); }
          if(t===T.Lava || t===T.Water || t===T.Gas) { ctx.fillStyle = "rgba(255,255,255,0.15)"; ctx.fillRect(x*TILE, y*TILE + Math.sin(performance.now()/200 + x*0.5)*5, TILE-1, TILE-1); }
          
          // Risse Animation
          let dmgRatio = damage[id] / T_D[t].hp;
          if(dmgRatio < 0.9 && t !== T.Pad && t !== T.Lava && t!==T.Water && t!==T.Gas) {
             ctx.strokeStyle = "rgba(0,0,0,0.6)"; ctx.lineWidth = 2; ctx.beginPath();
             if(dmgRatio < 0.9) { ctx.moveTo(x*TILE+10, y*TILE+10); ctx.lineTo(x*TILE+30, y*TILE+30); }
             if(dmgRatio < 0.6) { ctx.moveTo(x*TILE+40, y*TILE+10); ctx.lineTo(x*TILE+20, y*TILE+50); }
             if(dmgRatio < 0.3) { ctx.moveTo(x*TILE+5, y*TILE+40); ctx.lineTo(x*TILE+50, y*TILE+45); }
             ctx.stroke();
          }
        }
      }
    }

    if(worm.active) {
      ctx.fillStyle = "#8a2be2";
      for(let i=0; i<6; i++) {
        ctx.beginPath(); ctx.arc(worm.x - Math.sign(worm.vx)*i*18, worm.y + Math.sin(performance.now()/150 + i)*12, worm.r - i*2, 0, Math.PI*2); ctx.fill();
      }
      ctx.fillStyle="white"; ctx.beginPath(); ctx.arc(worm.x + Math.sign(worm.vx)*12, worm.y-8, 8, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle="black"; ctx.beginPath(); ctx.arc(worm.x + Math.sign(worm.vx)*14, worm.y-8, 4, 0, Math.PI*2); ctx.fill();
    }

    // Spieler (Bohrer)
    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.rotate(p.angle);
    
    let sharpColor = p.sharp > 50 ? "#0ff" : (p.sharp > 20 ? "#ff0" : "#f00");
    ctx.fillStyle = sharpColor;
    // Bohrkopf wackelt
    ctx.beginPath(); ctx.moveTo(18 + p.shake, -14); ctx.lineTo(42 + p.shake, 0); ctx.lineTo(18 + p.shake, 14); ctx.fill();
    ctx.fillStyle = "#dddddd"; ctx.beginPath(); ctx.roundRect(-25, -20, 45, 40, 8); ctx.fill();
    ctx.fillStyle = "#222"; ctx.fillRect(0, -12, 12, 24);

    // On-Drill HUD (Ringe)
    ctx.rotate(-p.angle); // Ringe drehen sich nicht mit
    ctx.lineWidth = 4; let r = 38;
    ctx.beginPath(); ctx.arc(0, 0, r, Math.PI+0.2, Math.PI*2-0.2); ctx.strokeStyle = "#311"; ctx.stroke();
    ctx.beginPath(); ctx.arc(0, 0, r, Math.PI+0.2, Math.PI+0.2 + (p.hp/p.hpM)*(Math.PI-0.4)); ctx.strokeStyle = "#ff4d4d"; ctx.stroke();
    ctx.beginPath(); ctx.arc(0, 0, r, Math.PI/2+0.2, Math.PI-0.2); ctx.strokeStyle = "#320"; ctx.stroke();
    ctx.beginPath(); ctx.arc(0, 0, r, Math.PI/2+0.2, Math.PI/2+0.2 + (p.f/p.fM)*(Math.PI/2-0.4)); ctx.strokeStyle = "#ffb84d"; ctx.stroke();
    ctx.beginPath(); ctx.arc(0, 0, r, 0.2, Math.PI/2-0.2); ctx.strokeStyle = "#012"; ctx.stroke();
    ctx.beginPath(); ctx.arc(0, 0, r, 0.2, 0.2 + (p.c/p.cM)*(Math.PI/2-0.4)); ctx.strokeStyle = "#4db8ff"; ctx.stroke();
    
    ctx.restore(); ctx.restore();

    // Popups
    ctx.textAlign = "center";
    popups.forEach(m => {
      ctx.font = `bold ${20 * m.s}px Arial`;
      ctx.fillStyle = m.c; ctx.globalAlpha = m.life;
      ctx.fillText(m.t, m.x - camX, m.y - camY);
    });
    ctx.globalAlpha = 1.0;

    document.getElementById("money-display").innerText = "$" + Math.floor(p.money);
    let depth = Math.floor(p.y/TILE - SURFACE);
    document.getElementById("depth-info").innerText = depth > 0 ? `Tiefe: ${depth}m` : `Höhe: ${Math.abs(depth)}m`;
  }
  requestAnimationFrame(update);
})();
</script>
</body>
</html>
